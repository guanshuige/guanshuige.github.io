<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>[转]APNS | 观水阁</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Apple Push Notification ServiceApple Push Notification service (APNs for short) is the centerpiece of the push notifications feature. It is a robust and highly efficient service for propagating inform">
<meta property="og:type" content="article">
<meta property="og:title" content="[转]APNS">
<meta property="og:url" content="http://yoursite.com/2012/11/03/转-APNS/index.html">
<meta property="og:site_name" content="观水阁">
<meta property="og:description" content="Apple Push Notification ServiceApple Push Notification service (APNs for short) is the centerpiece of the push notifications feature. It is a robust and highly efficient service for propagating inform">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_simple.jpg">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_multiple.jpg">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/service_device_ct.jpg">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/service_provider_ct.jpg">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/token_generation.jpg">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/registration_sequence.jpg">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/token_trust.jpg">
<meta property="og:updated_time" content="2016-10-20T08:24:51.910Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[转]APNS">
<meta name="twitter:description" content="Apple Push Notification ServiceApple Push Notification service (APNs for short) is the centerpiece of the push notifications feature. It is a robust and highly efficient service for propagating inform">
<meta name="twitter:image" content="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_simple.jpg">
  
    <link rel="alternate" href="/atom.xml" title="观水阁" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">观水阁</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-转-APNS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2012/11/03/转-APNS/" class="article-date">
  <time datetime="2012-11-03T08:04:59.000Z" itemprop="datePublished">2012-11-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [转]APNS
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Apple-Push-Notification-Service"><a href="#Apple-Push-Notification-Service" class="headerlink" title="Apple Push Notification Service"></a>Apple Push Notification Service</h1><p>Apple Push Notification service (APNs for short) is the centerpiece of the push notifications feature. It is a robust and highly efficient service for propagating information to devices such as iPhone, iPad, and iPod touch devices. Each device establishes<br> an accredited and encrypted IP connection with the service and receives notifications over this persistent connection. If a notification for an application arrives when that application is not running, the device alerts the user that the application has data<br> waiting for it. </p>
<p>Software developers (“providers”) originate the notifications in their server software. The provider connects with APNs through a persistent and secure channel while monitoring incoming data intended for their client applications. When new data for an application<br> arrives, the provider prepares and sends a notification through the channel to APNs, which pushes the notification to the target device.</p>
<p>In addition to being a simple but efficient and high-capacity transport service, APNs includes a default quality-of-service component that provides store-and-forward capabilities. See<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW4" target="_blank" rel="external">“Quality of Service”</a></span> for<br> more information. </p>
<p><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingWIthAPS/CommunicatingWIthAPS.html#//apple_ref/doc/uid/TP40008194-CH101-SW1" target="_blank" rel="external">“Provider Communication<br> with Apple Push Notification Service”</a></span> and <span class="content_text"><br><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/IPhoneOSClientImp/IPhoneOSClientImp.html#//apple_ref/doc/uid/TP40008194-CH103-SW1" target="_blank" rel="external">“Scheduling, Registering, and Handling Notifications”</a></span><br> discuss the specific implementation requirements for providers and iOS applications, respectively.</p>
<p><a title="A Push Notification and Its Path" name="//apple_ref/doc/uid/TP40008194-CH100-SW10"></a></p>
<h2 id="A-Push-Notification-and-Its-Path"><a href="#A-Push-Notification-and-Its-Path" class="headerlink" title="A Push Notification and Its Path"></a>A Push Notification and Its Path</h2><p>Apple Push Notification service transports and routes a notification from a given provider to a given device. A notification is a short message consisting of two major pieces of data: the device token and the payload. The device token is analogous to a phone<br> number; it contains information that enables APNs to locate the device on which the client application is installed. APNs also uses it to authenticate the routing of a notification. The payload is a JSON-defined property list that specifies how the user of<br> an application on a device is to be alerted.</p>
<div class="notebox"><a title="Note" name="//apple_ref/doc/uid/TP40008194-CH100-SW16"></a><br><br><strong>Note:</strong> For more information about the device token, see <span class="content_text"><br><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW3" target="_blank" rel="external">“Security Architecture”</a></span>; for further information about<br> the notification payload, see <span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW1" target="_blank" rel="external">“The<br> Notification Payload”</a></span> .<br><br></div>

<p>The flow of remote-notification data is one-way. The provider composes a notification package that includes the device token for a client application and the payload. The provider sends the notification to APNs which in turn pushes the notification to the<br> device.</p>
<p>When it authenticates itself to APNs, a provider furnishes the service with its topic, which identifies the application for which it’s providing data. The topic is currently the bundle identifier of the target application on an iOS device.</p>
<p><a title="Figure 3-1A push notification from a provider to a client application" name="//apple_ref/doc/uid/TP40008194-CH100-SW6"></a><strong>Figure 3-1</strong>&nbsp; A push notification from a provider to a client application<img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_simple.jpg" alt="A remote notification from a provider to a client application"></p>
<p><span class="content_text">Figure 3-1</span> is a greatly simplified depiction of the virtual network APNs makes possible among providers and devices. The device-facing and provider-facing sides of APNs both have multiple points of connection; on the provider-facing<br> side, these are called gateways. There are typically multiple providers, each making one or more persistent and secure connections with APNs through these gateways. And these providers are sending notifications through APNs to many devices on which their client<br> applications are installed. <span class="content_text">Figure 3-2</span> is a slightly more realistic depiction.</p>
<p><a title="Figure 3-2Push notifications from multiple providers to multiple devices" name="//apple_ref/doc/uid/TP40008194-CH100-SW7"></a><strong>Figure 3-2</strong>&nbsp; Push notifications from multiple providers to multiple devices<img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_multiple.jpg" alt="Remote notifications from multiple providers to multiple devices"><a title="Feedback Service" name="//apple_ref/doc/uid/TP40008194-CH100-SW17"></a></p>
<h2 id="Feedback-Service"><a href="#Feedback-Service" class="headerlink" title="Feedback Service"></a>Feedback Service</h2><p>Sometimes APNs might attempt to deliver notifications for an application on a device, but the device may repeatedly refuse delivery because there is no target application. This often happens when the user has uninstalled the application. In these cases,<br> APNs informs the provider through a feedback service that the provider connects with. The feedback service maintains a list of devices per application for which there were recent, repeated failed attempts to deliver notifications. The provider should obtain<br> this list of devices and stop sending notifications to them. For more on this service, see<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingWIthAPS/CommunicatingWIthAPS.html#//apple_ref/doc/uid/TP40008194-CH101-SW3" target="_blank" rel="external">“The Feedback Service.”</a></span></p>
<p><a title="Quality of Service" name="//apple_ref/doc/uid/TP40008194-CH100-SW4"></a></p>
<h2 id="Quality-of-Service"><a href="#Quality-of-Service" class="headerlink" title="Quality of Service"></a>Quality of Service</h2><p>Apple Push Notification Service includes a default Quality of Service (QoS) component that performs a store-and-forward function. If APNs attempts to deliver a notification but the device is offline, the QoS stores the notification. It retains only one notification<br> per application on a device: the last notification received from a provider for that application. When the offline device later reconnects, the QoS forwards the stored notification to the device. The QoS retains a notification for a limited period before deleting<br> it.</p>
<p><a title="Security Architecture" name="//apple_ref/doc/uid/TP40008194-CH100-SW3"></a></p>
<h2 id="Security-Architecture"><a href="#Security-Architecture" class="headerlink" title="Security Architecture"></a>Security Architecture</h2><p>To enable communication between a provider and a device, Apple Push Notification Service must expose certain entry points to them. But then to ensure security, it must also regulate access to these entry points. For this purpose, APNs requires two different<br> levels of trust for providers, devices, and their communications. These are known as connection trust and token trust.</p>
<p><strong>Connection trust</strong> establishes certainty that, on one side, the APNs connection is with an authorized provider with whom Apple has agreed to deliver notifications. At the device side of the connection, APNs must validate that the connection<br> is with a legitimate device.</p>
<p>After APNs has established trust at the entry points, it must then ensure that it conveys notifications to legitimate end points only. To do this, it must validate the routing of messages traveling through the transport; only the device that is the intended<br> target of a notification should receive it.</p>
<p>In APNs, assurance of accurate message routing—or <strong>token trust</strong>—is made possible through the device token. A device token is an opaque identifier of a device that APNs gives to the device when it first connects with it. The device shares the<br> device token with its provider. Thereafter, this token accompanies each notification from the provider. It is the basis for establishing trust that the routing of a particular notification is legitimate. (In a metaphorical sense, it has the same function as<br> a phone number, identifying the destination of a communication.)</p>
<div class="notebox"><a title="Note" name="//apple_ref/doc/uid/TP40008194-CH100-SW18"></a><br><br><strong>Note:</strong> A device token is not the same thing as the device UDID returned by the<br><code>[uniqueIdentifier](https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIDevice_Class/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/occ/instm/UIDevice/uniqueIdentifier)</code> property of<br><code>UIDevice</code>.<br><br></div>

<p>The following sections discuss the requisite components for connection trust and token trust as well as the four procedures for establishing trust.</p>
<p><a title="Service-to-Device Connection Trust" name="//apple_ref/doc/uid/TP40008194-CH100-SW5"></a></p>
<h3 id="Service-to-Device-Connection-Trust"><a href="#Service-to-Device-Connection-Trust" class="headerlink" title="Service-to-Device Connection Trust"></a>Service-to-Device Connection Trust</h3><p>APNs establishes the identity of a connecting device through TLS peer-to-peer authentication. (Note that iOS takes care of this stage of connection trust; you do not need to implement anything yourself.) In the course of this procedure, a device initiates<br> a TLS connection with APNs, which returns its server certificate. The device validates this certificate and then sends its device certificate to APNs, which validates that certificate.</p>
<p><img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/service_device_ct.jpg" alt="Service-to-device connection trust"><a title="Provider-to-Service Connection Trust" name="//apple_ref/doc/uid/TP40008194-CH100-SW11"></a></p>
<h3 id="Provider-to-Service-Connection-Trust"><a href="#Provider-to-Service-Connection-Trust" class="headerlink" title="Provider-to-Service Connection Trust"></a>Provider-to-Service Connection Trust</h3><p>Connection trust between a provider and APNs is also established through TLS peer-to-peer authentication. The procedure is similar to that described in<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW5" target="_blank" rel="external">“Service-to-Device Connection Trust.”</a></span><br> The provider initiates a TLS connection, gets the server certificate from APNs, and validates that certificate. Then the provider sends its provider certificate to APNs, which validates it on its end. Once this procedure is complete, a secure TLS connection<br> has been established; APNs is now satisfied that the connection has been made by a legitimate provider.</p>
<p><img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/service_provider_ct.jpg" alt="Provider-to-service connection trust"></p>
<p>Note that provider connection is valid for delivery to only one specific application, identified by the topic (bundle ID) specified in the certificate. APNs also maintains a certificate revocation list; if a provider’s certificate is on this list, APNs may<br> revoke provider trust (that is, refuse the connection). </p>
<p><a title="Token Generation and Dispersal" name="//apple_ref/doc/uid/TP40008194-CH100-SW12"></a></p>
<h3 id="Token-Generation-and-Dispersal"><a href="#Token-Generation-and-Dispersal" class="headerlink" title="Token Generation and Dispersal"></a>Token Generation and Dispersal</h3><p>An iOS-based application must <strong>register</strong> to receive push notifications; it typically does this right after it is installed on a device. (This procedure is described in<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/IPhoneOSClientImp/IPhoneOSClientImp.html#//apple_ref/doc/uid/TP40008194-CH103-SW1" target="_blank" rel="external">“Scheduling, Registering, and Handling<br> Notifications.”</a></span>) iOS receives the registration request from an application, connects with APNs, and forwards the request. APNs generates a device token using information contained in the unique device certificate. The device token contains an identifier<br> of the device. It then encrypts the device token with a token key and returns it to the device.</p>
<p><img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/token_generation.jpg" alt="Token generation and dispersal"></p>
<p>The device returns the device token to the requesting application as an <code>NSData</code> object. The application then must then deliver the device token to its provider in either binary or hexadecimal format.&nbsp;<br><span class="content_text">Figure 3-3</span> also illustrates the token generation and dispersal sequence, but in addition shows the role of the client application in furnishing its provider with the device token.</p>
<p><a title="Figure 3-3Sharing the device token" name="//apple_ref/doc/uid/TP40008194-CH100-SW8"></a><strong>Figure 3-3</strong>&nbsp; Sharing the device token<img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/registration_sequence.jpg" alt="Sharing the device token"></p>
<p>The form of this phase of token trust ensures that only APNs generates the token which it will later honor, and it can assure itself that a token handed to it by a device is the same token that it previously provisioned for that particular device—and only<br> for that device.</p>
<p><a title="Token Trust (Notification)" name="//apple_ref/doc/uid/TP40008194-CH100-SW13"></a></p>
<h3 id="Token-Trust-Notification"><a href="#Token-Trust-Notification" class="headerlink" title="Token Trust (Notification)"></a>Token Trust (Notification)</h3><p>After iOS obtains a device token from APNs, as described in <span class="content_text"><br><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW12" target="_blank" rel="external">“Token Generation and Dispersal,”</a></span> it must provide<br> APNs with the token every time it connects with it. APNs decrypts the device token and validates that the token was generated for the connecting device. To validate, APNs ensures that the device identifier contained in the token matches the device identifier<br> in the device certificate. </p>
<p>Every notification that a provider sends to APNs for delivery to a device must be accompanied by the device token it obtained from an application on that device. APNs decrypts the token using the token key, thereby ensuring that the notification is valid.<br> It then uses the device ID contained in the device token to determine the destination device for the notification.</p>
<p><img src="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/token_trust.jpg" alt="Token trust"><a title="Trust Components" name="//apple_ref/doc/uid/TP40008194-CH100-SW14"></a></p>
<h3 id="Trust-Components"><a href="#Trust-Components" class="headerlink" title="Trust Components"></a>Trust Components</h3><p>To support the security model for APNs, providers and devices must possess certain certificates, certificate authority (CA) certificates, or tokens.</p>
<ul>
<li><p><strong>Provider</strong>: Each provider requires a unique provider certificate and private cryptographic key for validating their connection with APNs. This certificate, provisioned by Apple, must identify the particular topic published by the provider;<br>the topic is the bundle ID of the client application. For each notification, the provider must furnish APNs with a device token identifying the target device. The provider may optionally wish to validate the service it is connecting to using the public server<br>certificate provided by the APNs server.</p>
</li>
<li><p><strong>Device</strong>: iOS uses the public server certificate passed to it by APNs to authenticate the service that it has connected to. It has a unique private key and certificate that it uses to authenticate itself to the service and establish the TLS<br>connection. It obtains the device certificate and key during device activation and stores them in the keychain. iOS also holds its particular device token, which it receives during the service connection process. Each registered client application is responsible<br>for delivering this token to its content provider.</p>
</li>
</ul>
<p>APNs servers also have the necessary certificates, CA certificates, and cryptographic keys (private and public) for validating connections and the identities of providers and devices.</p>
<p><a title="The Notification Payload" name="//apple_ref/doc/uid/TP40008194-CH100-SW1"></a></p>
<h2 id="The-Notification-Payload"><a href="#The-Notification-Payload" class="headerlink" title="The Notification Payload"></a>The Notification Payload</h2><p>Each push notification carries with it a payload. The payload specifies how users are to be alerted to the data waiting to be downloaded to the client application. The maximum size allowed for a notification payload is 256 bytes; Apple Push Notification<br> Service refuses any notification that exceeds this limit. Remember that delivery of notifications is “best effort” and is not guaranteed.</p>
<p>For each notification, providers must compose a JSON dictionary object that strictly adheres to RFC 4627. This dictionary must contain another dictionary identified by the key<br><code>aps</code>. The <code>aps</code> dictionary contains one or more properties that specify the following actions:</p>
<ul>
<li><p>An alert message to display to the user</p>
</li>
<li><p>A number to badge the application icon with</p>
</li>
<li><p>A sound to play<br><div class="notebox"><a title="Note" name="//apple_ref/doc/uid/TP40008194-CH100-SW19"></a></div></p>
</li>
</ul>
<p><strong>Note:</strong> Although you can combine an alert message, icon badging, and a sound in a single notification, you should consider the human-interface implications with push notifications. For example, a user might find frequent alert messages with<br> accompanying sound more annoying than useful, especially when the data to be downloaded is not critical.</p>
<p></p>
<p>If the target application isn’t running when the notification arrives, the alert message, sound, or badge value is played or shown. If the application is running, iOS delivers it to the application<br><span class="pediaLink"><a target="_self">delegate</a></span> as an <code>NSDictionary</code> object. The dictionary contains the corresponding Cocoa<br><span class="pediaLink"><a target="_self">property-list objects</a></span> (plus <code>NSNull</code>). </p>
<p>Providers can specify custom payload values outside the Apple-reserved <code>aps</code> namespace. Custom values must use the JSON structured and primitive types: dictionary (object), array, string, number, and Boolean. You should not include customer information<br> as custom payload data. Instead, use it for such purposes as setting context (for the user interface) or internal metrics. For example, a custom payload value might be a conversation identifier for use by an instant-message client application or a timestamp<br> identifying when the provider sent the notification. Any action associated with an alert message should not be destructive—for example, deleting data on the device.</p>
<div class="importantbox clear"><a title="Important" name="//apple_ref/doc/uid/TP40008194-CH100-DontLinkElementID_5"></a><br><br><strong>Important:</strong> Because delivery is not guaranteed, you should not depend on the remote-notifications facility for delivering critical data to an application via the payload. And never include sensitive data in the payload. You should use it<br> only to <em>notify</em> the user that new data is available.<br><br></div>

<p><span class="content_text">Table 3-1</span> lists the keys and expected values of the<br><code>aps</code> payload.</p>
<p><a title="Table 3-1Keys and values of the aps dictionary" name="//apple_ref/doc/uid/TP40008194-CH100-SW2"></a></p>
<div class="tableholder"><br><table class="graybox " border="0" cellspacing="0" cellpadding="5"><br><caption class="tablecaption"><strong>Table 3-1</strong>&nbsp; Keys and values of the<br><code>aps</code> dictionary</caption><br><tbody><br><tr><br><th class="TableHeading_TableRow_TableCell" scope="col"><br><br>Key<br><br></th><br><th class="TableHeading_TableRow_TableCell" scope="col"><br><br>Value type<br><br></th><br><th class="TableHeading_TableRow_TableCell" scope="col"><br><br>Comment<br><br></th><br></tr><br><tr><br><td scope="row"><br><br><code>alert</code><br><br></td><br><td><br><br>string or<br><br>dictionary<br><br></td><br><td><br><br>If this property is included, iOS displays a standard alert. You may specify a string as the value of<br><code>alert</code> or a dictionary as its value. If you specify a string, it becomes the message text of an alert with two buttons: Close and View. If the user taps View, the application is launched.&nbsp;<br><br>Alternatively, you can specify a dictionary as the value of <code>alert</code>. See<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW20" target="_blank" rel="external">Table 3-2</a></span> for descriptions<br> of the keys of this dictionary.<br><br></td><br></tr><br><tr><br><td scope="row"><br><br><code>badge</code><br><br></td><br><td><br><br>number<br><br></td><br><td><br><br>The number to display as the badge of the application icon. If this property is absent, the badge is not changed. To remove the badge, set the value of this property to<br><code>0</code>.<br><br></td><br></tr><br><tr><br><td scope="row"><br><br><code>sound</code><br><br></td><br><td><br><br>string<br><br></td><br><td><br><br>The name of a sound file in the application bundle. The sound in this file is played as an alert. If the sound file doesn’t exist or<br><code>default</code> is specified as the value, the default alert sound is played. The audio must be in one of the audio data formats that are compatible with system sounds; see<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/IPhoneOSClientImp/IPhoneOSClientImp.html#//apple_ref/doc/uid/TP40008194-CH103-SW6" target="_blank" rel="external">“Preparing Custom Alert Sounds”</a></span><br> for details.<br><br></td><br></tr><br></tbody><br></table><br></div>

<p><a title="Table 3-2Child properties of the alert property" name="//apple_ref/doc/uid/TP40008194-CH100-SW20"></a></p>
<div class="tableholder"><br><table class="graybox " border="0" cellspacing="0" cellpadding="5"><br><caption class="tablecaption"><strong>Table 3-2</strong>&nbsp; Child properties of the<br><code>alert</code> property</caption><br><tbody><br><tr><br><th class="TableHeading_TableRow_TableCell" scope="col"><br><br>Key<br><br></th><br><th class="TableHeading_TableRow_TableCell" scope="col"><br><br>Value type<br><br></th><br><th class="TableHeading_TableRow_TableCell" scope="col"><br><br>Comment<br><br></th><br></tr><br><tr><br><td scope="row"><br><br><code>body</code><br><br></td><br><td><br><br>string<br><br></td><br><td><br><br>The text of the alert message.<br><br></td><br></tr><br><tr><br><td scope="row"><br><br><code>action-loc-key</code><br><br></td><br><td><br><br>string or <code>null</code><br><br></td><br><td><br><br>If a string is specified, displays an alert with two buttons, whose behavior is described in<br><span class="content_text">Table 3-1</span>. However, iOS uses the string as a key to get a localized string in the current localization to use for the right button’s title instead of “View”. If the value is<br><code>null</code>, the system displays an alert with a single OK button that simply dismisses the alert when tapped. See<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW21" target="_blank" rel="external">“Localized Formatted Strings”</a></span><br> for more information.<br><br></td><br></tr><br><tr><br><td scope="row"><br><br><code>loc-key</code><br><br></td><br><td><br><br>string<br><br></td><br><td><br><br>A key to an alert-message string in a <code>Localizable.strings</code> file for the current localization (which is set by the user’s language preference). The key string can be formatted with<br><code>%@</code> and <code>%</code><em>n</em><code>$@</code> specifiers to take the variables specified in<br><code>loc-args</code>. See <span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW21" target="_blank" rel="external">“Localized<br> Formatted Strings”</a></span> for more information.<br><br></td><br></tr><br><tr><br><td scope="row"><br><br><code>loc-args</code><br><br></td><br><td><br><br>array of strings<br><br></td><br><td><br><br>Variable string values to appear in place of the format specifiers in <code>loc-key</code>. See<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW21" target="_blank" rel="external">“Localized Formatted Strings”</a></span><br> for more information.<br><br></td><br></tr><br><tr><br><td scope="row"><br><br><code>launch-image</code><br><br></td><br><td><br><br>string<br><br></td><br><td><br><br>The filename of an image file in the application bundle; it may include the extension or omit it. The image is used as the launch image when users tap the action button or move the action slider. If this property is not specified, the system either uses<br> the previous snapshot,uses the image identified by the <code>UILaunchImageFile</code> key in the application’s<br><code>Info.plist</code> file, or falls back to <code>Default.png</code>.<br><br>This property was added in iOS 4.0.<br><br></td><br></tr><br></tbody><br></table><br></div><br><div class="notebox"><a title="Note" name="//apple_ref/doc/uid/TP40008194-CH100-SW22"></a><br><br><strong>Note:</strong> If you want the iPhone, iPad, or iPod touch device to display the message text as-is in an alert that has both the Close and View buttons, then specify a string as the direct value of alert.<br><em>Don’t</em> specify a dictionary as the value of <code>alert</code> if the dictionary only has the<br><code>body</code> property.<br><br></div><br><a title="Localized Formatted Strings" name="//apple_ref/doc/uid/TP40008194-CH100-SW21"></a><br><br>### Localized Formatted Strings<br><br>You can display localized alert messages in two ways. The server originating the notification can localize the text; to do this, it must discover the current language preference selected for the device (see<br><span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/IPhoneOSClientImp/IPhoneOSClientImp.html#//apple_ref/doc/uid/TP40008194-CH103-SW3" target="_blank" rel="external">“Passing the Provider the Current<br> Language Preference (Remote Notifications)”</a></span>). Or the client application can store in its bundle the alert-message strings translated for each localization it supports. The provider specifies the<br><code>loc-key</code> and <code>loc-args</code> properties in the <code>aps</code> dictionary of the notification payload. When the device receives the notification (assuming the application isn’t running), it uses these<br><code>aps</code>-dictionary properties to find and format the string localized for the current language, which it then displays to the user.<br><br>Here’s how that second option works in a little more detail.<br><br>An iOS application can <span class="pediaLink"><a target="_self">internationalize</a></span> resources such as images, sounds, and text for each language that it supports, Internationalization collects the resources and puts them in a subdirectory of the<br> bundle with a two-part name: a language code and an extension of <code>.lproj</code> (for example,<br><code>fr.lproj</code>). Localized strings that are programmatically displayed are put in a file called<br><code>Localizable.strings</code>. Each entry in this file has a key and a localized string value; the string can have format specifiers for the substitution of variable values. When an application asks for a particular resource—say a localized string—it gets<br> the resource that is localized for the language currently selected by the user.&nbsp; For example, if the preferred language is French, the corresponding string value for an alert message would be fetched from<br><code>Localizable.strings</code> in the <code>fr.lproj</code> directory in the application bundle. (iOS makes this request through the<br><code>[NSLocalizedString](https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Miscellaneous/Foundation_Functions/Reference/reference.html#//apple_ref/c/macro/NSLocalizedString)</code> macro.)<br><br><div class="notebox"><a title="Note" name="//apple_ref/doc/uid/TP40008194-CH100-SW24"></a><br><br><strong>Note:</strong> This general pattern is also followed when the value of the<br><code>action-loc-key</code> property is a string. This string is a key into the <code>Localizable.strings</code> in the localization directory for the currently selected language. iOS uses this key to get the title of the button on the right side of an alert message (the “action” button).<br><br></div>

<p>To make this clearer, let’s consider an example. The provider specifies the following dictionary as the value of the alert property:</p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>&quot;alert&quot; : { &quot;loc-key&quot; : &quot;GAME_PLAY_REQUEST_FORMAT&quot;, &quot;loc-args&quot; : [ &quot;Jenna&quot;, &quot;Frank&quot;] },<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p>When the device receives the notification, it uses <code>&amp;quot;GAME_PLAY_REQUEST_FORMAT&amp;quot;</code> as a key to look up the associated string value in the<br><code>Localizable.strings</code> file in the <code>.lproj</code> directory for the current language. Assuming the current localization has an<br><code>Localizable.strings</code> entry such as this: </p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>&quot;GAME_PLAY_REQUEST_FORMAT&quot; = &quot;%@ and %@ have invited you to play Monopoly&quot;;<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p>the device displays an alert with the message “Jenna and Frank have invited you to play Monopoly”.</p>
<p>In addition to the format specifier <code>%@</code>, you can <code>%</code><em>n</em><code>$@</code> format specifiers for positional substitution of string variables. The<br><em>n</em> is the index (starting with 1) of the array value in <code>loc-args</code> to substitute. (There’s also the<br><code>%%</code> specifier for expressing a percentage sign (%).) So if the entry in<br><code>Localizable.strings</code> is this:</p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>&quot;GAME_PLAY_REQUEST_FORMAT&quot; = &quot;%2$@ and %1$@ have invited you to play Monopoly&quot;;<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p>the device displays an alert with the message &quot;Frank and Jenna have invited you to play Monopoly&quot;.</p>
<p>For a full example of a notification payload that uses the <code>loc-key</code> and<br><code>loc-arg</code> properties, see the last example of <span class="content_text"><br>“Examples of JSON Payloads.”</span> To learn more about internationalization in iOS, see “<span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/AdvancedAppTricks/AdvancedAppTricks.html#//apple_ref/doc/uid/TP40007072-CH7" target="_blank" rel="external">“Advanced<br> App Tricks”</a></span>” in _<a href="https://developer.apple.com/library/ios/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007072" target="_blank" rel="external">iOS App Programming Guide</a><em>; for general<br> information about internationalization, see </em><a href="https://developer.apple.com/library/ios/documentation/MacOSX/Conceptual/BPInternational/BPInternational.html#//apple_ref/doc/uid/10000171i" target="_blank" rel="external">Internationalization Programming Topics</a>_.<br> String formatting is discussed in <span class="content_text"><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Strings/Articles/FormatStrings.html#//apple_ref/doc/uid/20000943" target="_blank" rel="external">“Formatting String Objects”</a></span><br> in _<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Strings/introStrings.html#//apple_ref/doc/uid/10000035i" target="_blank" rel="external">String Programming Guide</a>_.</p>
<div class="notebox"><a title="Note" name="//apple_ref/doc/uid/TP40008194-CH100-SW23"></a><br><br><strong>Note:</strong> You should use the <code>loc-key</code> and <code>loc-args</code> properties—and the<br><code>alert</code> dictionary in general—only if you absolutely need to. The values of these properties, especially if they are long strings, might use up more bandwidth than is good for performance. Many if not most applications may not need these properties<br> because their message strings are originated by users and thus are implicitly &quot;localized.&quot;<br><br></div><br><a title="Examples of JSON Payloads" name="//apple_ref/doc/uid/TP40008194-CH100-SW15"></a><br><br>### Examples of JSON Payloads<br><br>The following examples of the payload portion of notifications illustrate the practical use of the properties listed in<br><span class="content_text">Table 3-1</span>. Properties with “acme” in the key name are examples of custom payload data. The examples include whitespace and newline characters for readability; for better performance, providers should omit whitespace and newline<br> characters.<br><br><strong>Example 1</strong>: The following payload has an <code>aps</code> dictionary with a simple, recommended form for alert messages with the default alert buttons (Close and View). It uses a string as the value of<br><code>alert</code> rather than a dictionary. This payload also has a custom array property.<br><br><div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>{<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;aps&quot; : { &quot;alert&quot; : &quot;Message received from Bob&quot; },<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;acme2&quot; : [ &quot;bang&quot;,  &quot;whiz&quot; ]<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>}<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p><strong>Example 2</strong>. The payload in the example uses an <code>aps</code> dictionary to request that the device display an alert message with an Close button on the left and a localized title for the &quot;action&quot; button on the right side of the alert.<br> In this case, “PLAY” is used as a key into the <code>Localizable.strings</code> file for the currently selected language to get the localized equivalent of “Play”. The<br><code>aps</code> dictionary also requests that the application icon be badged with 5.</p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>{     &quot;aps&quot; : {         &quot;alert&quot; : { &quot;body&quot; : &quot;Bob wants to play poker&quot;, &quot;action-loc-key&quot; : &quot;PLAY&quot; },         &quot;badge&quot; : 5,     },     &quot;acme1&quot; : &quot;bar&quot;,     &quot;acme2&quot; : [ &quot;bang&quot;,  &quot;whiz&quot; ] }<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p><strong>Example 3</strong>. The payload in this example specifies that device should display an alert message with both Close and View buttons. It also request that the application icon be badged with 9 and that a bundled alert sound be played when the notification<br> is delivered.</p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>{<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;aps&quot; : {<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>        &quot;alert&quot; : &quot;You got your emails.&quot;,<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>        &quot;badge&quot; : 9,<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>        &quot;sound&quot; : &quot;bingbong.aiff&quot;<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    },<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;acme1&quot; : &quot;bar&quot;,<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;acme2&quot; : 42<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>}<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p><strong>Example 4</strong>. The interesting thing about the payload in this example is that it uses the<br><code>loc-key</code> and <code>loc-args</code> child properties of the <code>alert</code> dictionary to fetch a formatted localized string from the application’s bundle and substitute the variable string values (<code>loc-args</code>) in the appropriate places.<br> It also specifies a custom sound and include a custom property. </p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>{<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;aps&quot; : {<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>        &quot;alert&quot; : { &quot;loc-key&quot; : &quot;GAME_PLAY_REQUEST_FORMAT&quot;, &quot;loc-args&quot; : [ &quot;Jenna&quot;, &quot;Frank&quot;] },<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>        &quot;sound&quot; : &quot;chime&quot;<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    },<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;acme&quot; : &quot;foo&quot;<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>}<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p><strong>Example 5</strong>. The following example shows an empty <code>aps</code> dictionary; because the<br><code>badge</code> property is missing, any current badge number shown on the application icon is removed. The<br><code>acme2</code> custom property is an array of two integers.</p>
<div class="codesample clear"><br><table><br><tbody><br><tr><br><td scope="row"><br><pre>{<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;aps&quot; : {<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    },<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>    &quot;acme2&quot; : [ 5,  8 ]<span></span></pre><br></td><br></tr><br><tr><br><td scope="row"><br><pre>}<span></span></pre><br></td><br></tr><br></tbody><br></table><br></div>

<p>Remember, for better performance, you should strip all whitespace and newline characters from the payload before including it in the notification</p>
<pre><code>&lt;div&gt;
    作者：kkaxiao 发表于2012/11/3 16:04:59 [原文链接](http://blog.csdn.net/kkaxiao/article/details/8143791)
&lt;/div&gt;
&lt;div&gt;
阅读：1237 评论：0 [查看评论](http://blog.csdn.net/kkaxiao/article/details/8143791#comments)
&lt;/div&gt;
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2012/11/03/转-APNS/" data-id="cius3b9gy0003g4if0o1nmhot" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2012/12/29/转-如何在IOS中使用block/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          [转]如何在IOS中使用block
        
      </div>
    </a>
  
  
    <a href="/2012/09/11/转-软件许可协议解析/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">[转]软件许可协议解析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">September 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/12/02/原-net学习框架/">[原].net学习框架</a>
          </li>
        
          <li>
            <a href="/2013/12/02/转-理解和配置-Linux-下的-OOM-Killer/">[转]理解和配置 Linux 下的 OOM Killer</a>
          </li>
        
          <li>
            <a href="/2013/07/16/转-使用epoll实现客户端UDP并发/">[转]使用epoll实现客户端UDP并发</a>
          </li>
        
          <li>
            <a href="/2013/06/27/转-关于Tcp封包/">[转]关于Tcp封包</a>
          </li>
        
          <li>
            <a href="/2012/12/29/转-如何在IOS中使用block/">[转]如何在IOS中使用block</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Ronger<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>